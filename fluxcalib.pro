pro fluxcalib

;parameters

;STANDARD 088 089
;stdfile='./specphotdata/feige110.dat'
;file1='../vp_proc/proc_data_nov07/vp4698pefs.fits'
;file2='../vp_proc/proc_data_nov07/vp4699pefs.fits'
;file3='../vp_proc/proc_data_nov07/vp4700pefs.fits'
;file4='../vp_proc/proc_data_nov07/vp4701pefs.fits'
;file5='../vp_proc/proc_data_nov07/vp4702pefs.fits'
;file6='../vp_proc/proc_data_nov07/vp4703pefs.fits'
;ptowfile='../vp_proc/proc_data_nov07/ptow_vpNov07_n1.dat'
;fiber0=123-1

;STANDARD 090 091
;stdfile='./specphotdata/feige110.dat'
;file1='../vp_proc/proc_data_nov07/vp4710pefs.fits'
;file2='../vp_proc/proc_data_nov07/vp4711pefs.fits'
;file3='../vp_proc/proc_data_nov07/vp4712pefs.fits'
;file4='../vp_proc/proc_data_nov07/vp4713pefs.fits'
;file5='../vp_proc/proc_data_nov07/vp4714pefs.fits'
;file6='../vp_proc/proc_data_nov07/vp4715pefs.fits'
;ptowfile='../vp_proc/proc_data_nov07/ptow_vpNov07_n1.dat'
;weightfile='../vp_proc/proc_data_nov07/vp4710pefw.fits'
;exptime=120.
;fiber0=123-1

;STANDARD 092 093
;stdfile='./specphotdata/pg0310a.dat'
;file1='../vp_proc/proc_data_nov07/vp4728pefs.fits'
;file2='../vp_proc/proc_data_nov07/vp4729pefs.fits'
;file3='../vp_proc/proc_data_nov07/vp4730pefs.fits'
;file4='../vp_proc/proc_data_nov07/vp4731pefs.fits'
;file5='../vp_proc/proc_data_nov07/vp4732pefs.fits'
;file6='../vp_proc/proc_data_nov07/vp4733pefs.fits'
;ptowfile='../vp_proc/proc_data_nov07/ptow_vpNov07_n1.dat'
;fiber0=124-1

;STANDARD 094 095
;stdfile='./specphotdata/g191b2b.dat'
;file1='../vp_proc/proc_data_nov07/vp4740pefs.fits'
;file2='../vp_proc/proc_data_nov07/vp4741pefs.fits'
;file3='../vp_proc/proc_data_nov07/vp4742pefs.fits'
;file4='../vp_proc/proc_data_nov07/vp4743pefs.fits'
;file5='../vp_proc/proc_data_nov07/vp4744pefs.fits'
;file6='../vp_proc/proc_data_nov07/vp4745pefs.fits'
;ptowfile='../vp_proc/proc_data_nov07/ptow_vpNov07_n1.dat'
;fiber0=139-1

;STANDARD 096 097
stdfile='./specphotdata/feige110.dat'
file1='../vp_proc/proc_data_nov07/vp4814pefs.fits'
file2='../vp_proc/proc_data_nov07/vp4815pefs.fits'
file3='../vp_proc/proc_data_nov07/vp4816pefs.fits'
file4='../vp_proc/proc_data_nov07/vp4817pefs.fits'
file5='../vp_proc/proc_data_nov07/vp4818pefs.fits'
file6='../vp_proc/proc_data_nov07/vp4819pefs.fits'
ptowfile='../vp_proc/proc_data_nov07/ptow_vpNov07_n2.dat'
weightfile='../vp_proc/proc_data_nov07/vp4814pefw.fits'
exptime=120.
fiber0=123-1
airmass=1.47

;STANDARD 098 099
;stdfile='./specphotdata/feige110.dat'
;file1='../vp_proc/proc_data_nov07/vp4826pefs.fits'
;file2='../vp_proc/proc_data_nov07/vp4827pefs.fits'
;file3='../vp_proc/proc_data_nov07/vp4828pefs.fits'
;file4='../vp_proc/proc_data_nov07/vp4829pefs.fits'
;file5='../vp_proc/proc_data_nov07/vp4830pefs.fits'
;file6='../vp_proc/proc_data_nov07/vp4831pefs.fits'
;ptowfile='../vp_proc/proc_data_nov07/ptow_vpNov07_n2.dat'
;weightfile='../vp_proc/proc_data_nov07/vp4826pefw.fits'
;exptime=120.
;fiber0=123-1

;STANDARD 116 117
;wrongstdfile='./specphotdata/feige110.dat'
;file1='../vp_proc/proc_data_dec07/vp5521pefs.fits'
;file2='../vp_proc/proc_data_dec07/vp5522pefs.fits'
;file3='../vp_proc/proc_data_dec07/vp5523pefs.fits'
;file4='../vp_proc/proc_data_dec07/vp5524pefs.fits'
;file5='../vp_proc/proc_data_dec07/vp5525pefs.fits'
;file6='../vp_proc/proc_data_dec07/vp5526pefs.fits'
;wrongptowfile='../vp_proc/proc_data_nov07/ptow_vpNov07_n2.dat'
;wrongfiber0=123-1

;file1='../vp_proc/proc_data_dec07/vp5545pefs.fits'
;file2='../vp_proc/proc_data_dec07/vp5546pefs.fits'
;file3='../vp_proc/proc_data_dec07/vp5547pefs.fits'
;file4='../vp_proc/proc_data_dec07/vp5548pefs.fits'
;file5='../vp_proc/proc_data_dec07/vp5549pefs.fits'
;file6='../vp_proc/proc_data_dec07/vp5550pefs.fits'

;file1='../vp_proc/proc_data_dec07/vp5636pefs.fits'
;file2='../vp_proc/proc_data_dec07/vp5637pefs.fits'
;file3='../vp_proc/proc_data_dec07/vp5638pefs.fits'
;file4='../vp_proc/proc_data_dec07/vp5639pefs.fits'
;file5='../vp_proc/proc_data_dec07/vp5640pefs.fits'
;file6='../vp_proc/proc_data_dec07/vp5641pefs.fits'

;file1='../vp_proc/proc_data_dec07/vp5660pefs.fits'
;file2='../vp_proc/proc_data_dec07/vp5661pefs.fits'
;file3='../vp_proc/proc_data_dec07/vp5662pefs.fits'
;file4='../vp_proc/proc_data_dec07/vp5663pefs.fits'
;file5='../vp_proc/proc_data_dec07/vp5664pefs.fits'
;file6='../vp_proc/proc_data_dec07/vp5665pefs.fits'

;file1='../vp_proc/proc_data_dec07/vp5666pefs.fits'
;file2='../vp_proc/proc_data_dec07/vp5667pefs.fits'
;file3='../vp_proc/proc_data_dec07/vp5668pefs.fits'
;file4='../vp_proc/proc_data_dec07/vp5669pefs.fits'
;file5='../vp_proc/proc_data_dec07/vp5670pefs.fits'
;file6='../vp_proc/proc_data_dec07/vp5671pefs.fits'


;STANDARD  160 161
;stdfile='./specphotdata/g191b2b.dat'
;file1='../vp_proc/proc_data_feb08/vp1164pefs.fits'
;file2='../vp_proc/proc_data_feb08/vp1165pefs.fits'
;file3='../vp_proc/proc_data_feb08/vp1166pefs.fits'
;file4='../vp_proc/proc_data_feb08/vp1167pefs.fits'
;file5='../vp_proc/proc_data_feb08/vp1168pefs.fits'
;file6='../vp_proc/proc_data_feb08/vp1169pefs.fits'
;ptowfile='../vp_proc/proc_data_feb08/ptow_feb08_n8.dat'
;weightfile='../vp_proc/proc_data_feb08/vp1164pefw.fits'
;exptime=120.
;fiber0=139-1

;STANDARD  162 163
;stdfile='./specphotdata/g191b2b.dat'
;file1='../vp_proc/proc_data_feb08/vp1333pefs.fits'
;file2='../vp_proc/proc_data_feb08/vp1334pefs.fits'
;file3='../vp_proc/proc_data_feb08/vp1335pefs.fits'
;file4='../vp_proc/proc_data_feb08/vp1336pefs.fits'
;file5='../vp_proc/proc_data_feb08/vp1337pefs.fits'
;file6='../vp_proc/proc_data_feb08/vp1338pefs.fits'
;ptowfile='../vp_proc/proc_data_feb08/ptow_feb08_n9.dat'
;weightfile='../vp_proc/proc_data_feb08/vp1164pefw.fits'
;exptime=120.
;fiber0=139-1


;file1='../vp_proc/proc_data_feb08/vp0973pefs.fits'
;file2='../vp_proc/proc_data_feb08/vp0974pefs.fits'
;file3='../vp_proc/proc_data_feb08/vp0975pefs.fits'
;file4='../vp_proc/proc_data_feb08/vp0976pefs.fits'
;file5='../vp_proc/proc_data_feb08/vp0977pefs.fits'
;file6='../vp_proc/proc_data_feb08/vp0978pefs.fits'


;file1='./data/vp3911pefs.fits'
;file2='./data/vp3912pefs.fits'
;file3='./data/vp3913pefs.fits'
;file4='./data/vp3914pefs.fits'
;file5='./data/vp3915pefs.fits'
;file6='./data/vp3916pefs.fits'


R0=12 ; radius arround fiber0 to calculate barycenter
aperture=5
halfap=floor(aperture/2.0)

;GET STANDARD STAR DATA

readcol, stdfile, sl, sm, comment="#"
sfnu=10.0^(-0.4*(sm+48.59)) ; flux denisty in ergs/s/cm2/Hz
c=299792458.0e10 ; c in A/s
sflam=(c/sl^2)*sfnu ; flux density in ergs/s/cm2/A

;CORRECT STANDARD STAR FLUX FOR AIRMASS

readcol, 'extinc_McD.dat', elam, ecoeff, comment="#"
linterp, elam*10.0, ecoeff, sl, ecoeffint
sflam=sflam*10.0^(-0.4*ecoeffint*airmass)

;READ FITS FILES

d1=mrdfits(file1,0,h)
d2=mrdfits(file2,0,h)
d3=mrdfits(file3,0,h)
d4=mrdfits(file4,0,h)
d5=mrdfits(file5,0,h)
d6=mrdfits(file6,0,h)
weight=mrdfits(weightfile,0,h)
;READ COORDINATES OF EACH FIBER

readcol, 'IFUcen.txt', fn, fx1, fy1
fx2=fx1+3.8
fy2=fy1-2.1
fx3=fx2-3.8
fy3=fy2-2.1
fx4=fx3-1.2
fy4=fy3+2.1
fx5=fx4+3.8
fy5=fy4+2.1
fx6=fx5
fy6=fy5-4.2

;FIND CENTER OF THE STAR

aux1=d1
aux2=d2
aux3=d3
aux4=d4
aux5=d5
aux6=d6

aux1[where(d1 eq -666)]=0
aux2[where(d2 eq -666)]=0
aux3[where(d3 eq -666)]=0
aux4[where(d4 eq -666)]=0
aux5[where(d5 eq -666)]=0
aux6[where(d6 eq -666)]=0

totflux1=fltarr(247)
totflux2=fltarr(247)
totflux3=fltarr(247)
totflux4=fltarr(247)
totflux5=fltarr(247)
totflux6=fltarr(247)

xblue=0
xred=1024-1
for j=0, 247-1 do begin
        y1=(j+1)*8-halfap
        y2=(j+1)*8+halfap
        totflux1[j]=total(aux1[xblue:xred,y1:y2])
        totflux2[j]=total(aux2[xblue:xred,y1:y2])
        totflux3[j]=total(aux3[xblue:xred,y1:y2])
        totflux4[j]=total(aux4[xblue:xred,y1:y2])
        totflux5[j]=total(aux5[xblue:xred,y1:y2])
        totflux6[j]=total(aux6[xblue:xred,y1:y2])
endfor

;CROSS TALK RAW CORRECTION

;for j=1, 246-1 do begin
;        totflux1[j]=totflux1[j]-0.03*totflux1[j-1]-0.03*totflux1[j+1]
;        totflux2[j]=totflux2[j]-0.03*totflux2[j-1]-0.03*totflux2[j+1]
;        totflux3[j]=totflux3[j]-0.03*totflux3[j-1]-0.03*totflux3[j+1]
;        totflux4[j]=totflux4[j]-0.03*totflux4[j-1]-0.03*totflux4[j+1]
;        totflux5[j]=totflux5[j]-0.03*totflux5[j-1]-0.03*totflux5[j+1]
;        totflux6[j]=totflux6[j]-0.03*totflux6[j-1]-0.03*totflux6[j+1]
;endfor


thresh=5*median([totflux1,totflux2,totflux3,totflux4,totflux5,totflux6])

sel1=where(sqrt(abs(fx1-fx1[fiber0])^2+abs(fy1-fy1[fiber0])^2) le R0 and totflux1 ge thresh)
sel2=where(sqrt(abs(fx2-fx1[fiber0])^2+abs(fy2-fy1[fiber0])^2) le R0 and totflux2 ge thresh)
sel3=where(sqrt(abs(fx3-fx1[fiber0])^2+abs(fy3-fy1[fiber0])^2) le R0 and totflux3 ge thresh)
sel4=where(sqrt(abs(fx4-fx1[fiber0])^2+abs(fy4-fy1[fiber0])^2) le R0 and totflux4 ge thresh)
sel5=where(sqrt(abs(fx5-fx1[fiber0])^2+abs(fy5-fy1[fiber0])^2) le R0 and totflux5 ge thresh)
sel6=where(sqrt(abs(fx6-fx1[fiber0])^2+abs(fy6-fy1[fiber0])^2) le R0 and totflux6 ge thresh)

wx1=fx1[sel1]*totflux1[sel1]
wx2=fx2[sel2]*totflux2[sel2]
wx3=fx3[sel3]*totflux3[sel3]
wx4=fx4[sel4]*totflux4[sel4]
wx5=fx5[sel5]*totflux5[sel5]
wx6=fx6[sel6]*totflux6[sel6]

sx=total([wx1,wx2,wx3,wx4,wx5,wx6])/total([totflux1[sel1],totflux2[sel2],totflux3[sel3],totflux4[sel4],totflux5[sel5],totflux6[sel6]])

wy1=fy1[sel1]*totflux1[sel1]
wy2=fy2[sel2]*totflux2[sel2]
wy3=fy3[sel3]*totflux3[sel3]
wy4=fy4[sel4]*totflux4[sel4]
wy5=fy5[sel5]*totflux5[sel5]
wy6=fy6[sel6]*totflux6[sel6]

sy=total([wy1,wy2,wy3,wy4,wy5,wy6])/total([totflux1[sel1],totflux2[sel2],totflux3[sel3],totflux4[sel4],totflux5[sel5],totflux6[sel6]])

; MAKE GAUSSIAN/MOFFAT MODEL OF THE STAR

r1=sqrt((fx1[sel1]-sx)^2+(fy1[sel1]-sy)^2)
r2=sqrt((fx2[sel2]-sx)^2+(fy2[sel2]-sy)^2)
r3=sqrt((fx3[sel3]-sx)^2+(fy3[sel3]-sy)^2)
r4=sqrt((fx4[sel4]-sx)^2+(fy4[sel4]-sy)^2)
r5=sqrt((fx5[sel5]-sx)^2+(fy5[sel5]-sy)^2)
r6=sqrt((fx6[sel6]-sx)^2+(fy6[sel6]-sy)^2)

r=[r1,r2,r3,r4,r5,r6]
flux=[totflux1[sel1],totflux2[sel2],totflux3[sel3],totflux4[sel4],totflux5[sel5],totflux6[sel6]]
fibernum=[sel1,sel2,sel3,sel4,sel5,sel6]
dither=[sel1/sel1+0,sel2/sel2+1,sel3/sel3+2,sel4/sel4+3,sel5/sel5+4,sel6/sel6+5]



flux=flux[where(r le 8.0)]
fibernum=fibernum[where(r le 8.0)]
dither=dither[where(r le 8.0)]
fweight=flux/flux
r=r[where(r le 8.0)]

flux=flux[sort(r)]
fibernum=fibernum[sort(r)]
dither=dither[sort(r)]
r=r[sort(r)]

;GAUSSIAN

ag=[flux[0]/(!pi*2.1^2), 1.5/2.35]
fitg = CURVEFIT(r, flux, fweight, ag, sigmag, FUNCTION_NAME='gaussian', /NODERIVATIVE)

;MOFFAT

am=[flux[0]/(!pi*2.1^2), 2.0, 1.0]
fitm = CURVEFIT(r, flux, fweight, am, sigmam, FUNCTION_NAME='moffat', /NODERIVATIVE)

;2D SURFACE FOR GAUSSIAN AND MOFFAT
xarr=fltarr(100,100)
yarr=fltarr(100,100)
for i=0, (size(xarr))[1]-1 do begin
    xarr[i,*]=i-((size(xarr))[1]-1)/2.0
    yarr[*,i]=i-((size(xarr))[2]-1)/2.0
endfor
rarr=sqrt(xarr^2+yarr^2)/5.0
gauss=ag[0]*exp(-rarr^2/(2*ag[1]^2))
moff=am[0]*(1+(rarr/am[1])^2)^(-am[2])
fiber=fltarr(100,100)
fiber[where(rarr le 2.1)]=1.0

; FRACTION OF TOTAL FLUX 

gausstot=2*!pi*ag[0]*ag[1]^2
;gausstot2=total(gauss)*0.2*0.2
mofftot=total(moff)*0.2*0.2

fracg=flux/gausstot
fracm=flux/mofftot


print, "GAUSSIAN"
print, "Fraction in D1-D3= ", total(fracg[where(dither eq 1 or dither eq 2 or dither eq 3)])
print, "Fraction in D4-D6= ", total(fracg[where(dither eq 4 or dither eq 5 or dither eq 6)])

print, "MOFFAT"
print, "Fraction in D1-D3= ", total(fracm[where(dither eq 1 or dither eq 2 or dither eq 3)])
print, "Fraction in D4-D6= ", total(fracm[where(dither eq 4 or dither eq 5 or dither eq 6)])

; EXTRACT 1D SPECTRUM FOR EACH SELECTED FIBER

readcol, ptowfile, a1, a2, a3, a4, a5
lambda=fltarr(247,1024)
xaux=findgen(1024)
for i=0, 247-1 do lambda[i,*]=a1[i]+a2[i]*xaux+a3[i]*xaux^2+a4[i]*xaux^3+a5[i]*xaux^4

weight[where(weight eq -666)]=0
w1=aux1*weight
w2=aux2*weight
w3=aux3*weight
w4=aux4*weight
w5=aux5*weight
w6=aux6*weight

onedspec=fltarr(n_elements(r),1024)
for i=0, n_elements(r)-1 do begin
    for j=0, 1024-1 do begin
       if (dither[i] eq 1) then begin
            norm=total(weight[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])
            if (norm ne 0) then onedspec[i,j]=total(w1[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])/norm
            if (norm eq 0) then onedspec[i,j]=-666
        endif
       if (dither[i] eq 2) then begin
            norm=total(weight[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])
            if (norm ne 0) then onedspec[i,j]=total(w2[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])/norm
            if (norm eq 0) then onedspec[i,j]=-666
        endif
       if (dither[i] eq 3) then begin
            norm=total(weight[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])
            if (norm ne 0) then onedspec[i,j]=total(w3[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])/norm
            if (norm eq 0) then onedspec[i,j]=-666
        endif
       if (dither[i] eq 4) then begin
            norm=total(weight[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])
            if (norm ne 0) then onedspec[i,j]=total(w4[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])/norm
            if (norm eq 0) then onedspec[i,j]=-666
        endif
       if (dither[i] eq 5) then begin
            norm=total(weight[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])
            if (norm ne 0) then onedspec[i,j]=total(w5[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])/norm
            if (norm eq 0) then onedspec[i,j]=-666
        endif
       if (dither[i] eq 6) then begin
            norm=total(weight[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])
            if (norm ne 0) then onedspec[i,j]=total(w6[j,(fibernum[i]+1)*8-halfap:(fibernum[i]+1)*8+halfap])/norm
            if (norm eq 0) then onedspec[i,j]=-666
        endif        
    endfor
endfor

totalspec=fltarr(1024)
for i=0, 1024-1 do totalspec[i]=total(onedspec[*,i])
totalspec=totalspec/total(fracm)/exptime ; ADU/s/pixel
totalspec[0]=totalspec[1]

lambdatot=fltarr(1024)
for i=0, 1024-1 do lambdatot[i]=lambda[fibernum[0],i]

; INTERPOLATE TO STANDARD SAMPLING TRANSFORM TO

;stop
linterp, sl, sflam, lambdatot, sflamint

; CALIBRATION FACTOR TO GO FROM ADU/s/pixel TO ergs/s/cm2/A

factor0=sflamint/totalspec
factor=medsmooth(factor0,100)


openw, lun, 'fluxcalibfactor.dat', /get_lun
for i=0, n_elements(factor)-1 do printf, lun, i, lambdatot[i], factor[i]
free_lun, lun


; PLOTTING STUFF

window, 0, retain=2, xsize=500, ysize=1000
device, decomposed=0
loadct, 39
!p.multi=[0,1,2,0,0]

plot, r, flux, psym=2, xtitle="radius (arcsec)", ytitle="flux", yrange=[0,max([max(gauss),max(moff)])*!pi*2.1^2], xrange=[0,8], ystyle=1, xstyle=1
oplot, r, fitg, color=50
oplot, r, fitm, color=150
oplot, rarr, gauss*!pi*2.1^2, color=50
oplot, rarr, moff*!pi*2.1^2, color=150


plot, fx1, fy1, psym=2
oplot, fx1[sel1], fy1[sel1], psym=2, color=150
oplot, fx2[sel2], fy2[sel2], psym=2, color=150
oplot, fx3[sel3], fy3[sel3], psym=2, color=150
oplot, fx4[sel4], fy4[sel4], psym=2, color=150
oplot, fx5[sel5], fy5[sel5], psym=2, color=150
oplot, fx6[sel6], fy6[sel6], psym=2, color=150
tvcircle, R0, fx1[fiber0], fy1[fiber0], /data
tvcircle, 8, sx, sy, color=250, /data
oplot, [sx], [sy], psym=2, color=250


print, "Gaussian FWHM= ",2.35*ag[1] 
print, "Moffat FWHM= ",2.*abs(am[1])*sqrt((2.)^(1./am[2])-1) 


window, 1, retain=2, xsize=500, ysize=500
device, decomposed=0
loadct, 39
!p.multi=[0,1,1,0,0]
plot, lambda[fibernum[n_elements(r)-1],*], onedspec[n_elements(r)-1,*]/fracm[n_elements(r)-1]/exptime
for i=1, n_elements(r)-1 do oplot, lambda[fibernum[n_elements(r)-1-i],*], onedspec[n_elements(r)-1-i,*]/fracm[n_elements(r)-1-i]/exptime, color=i*15
oplot, lambdatot, totalspec, thick=4


;oplot, rarr, moff



stop
end


pro gaussian, x, a, f ; x is the fibers flux, p are the gaussian parameters and r are the fiber distance
;p=[amplitude,sigma]
xarr=fltarr(1000,1000)
yarr=fltarr(1000,1000)
for i=0, (size(xarr))[1]-1 do begin
    xarr[i,*]=i-((size(xarr))[1]-1)/2.0
    yarr[*,i]=i-((size(xarr))[2]-1)/2.0
endfor
rarr=sqrt(xarr^2+yarr^2)/50.0
gauss=a[0]*exp(-rarr^2/(2*a[1]^2))
fiber=fltarr(1000,1000)
fiber[where(rarr le 2.1)]=1.0
F=fltarr(n_elements(x))
fiber2=fltarr(1000,1000)
for i=0, n_elements(x)-1 do begin
    fiber2[fix(x[i]/0.02):999,*]=fiber[0:999-fix(x[i]/0.02),*]
    F[i]=total(gauss*fiber2)*0.02*0.02
endfor
;return, fit
end

pro moffat, x, a, f; x is the fibers flux, p are the moffat parameters and r are the fiber distance
;p=[amplitude,alpha,beta]
xarr=fltarr(1000,1000)
yarr=fltarr(1000,1000)
for i=0, (size(xarr))[1]-1 do begin
    xarr[i,*]=i-((size(xarr))[1]-1)/2.0
    yarr[*,i]=i-((size(xarr))[2]-1)/2.0
endfor
rarr=sqrt(xarr^2+yarr^2)/50.0
moff=a[0]*(1+(rarr/a[1])^2)^(-a[2])
;fwhm=2.*a[1]*sqrt((2.*a[0])^(1./a[2])-1)
fiber=fltarr(1000,1000)
fiber[where(rarr le 2.1)]=1.0
F=fltarr(n_elements(x))
fiber2=fltarr(1000,1000)
for i=0, n_elements(x)-1 do begin
    fiber2[fix(x[i]/0.02):999,*]=fiber[0:999-fix(x[i]/0.02),*]
    F[i]=total(moff*fiber2)*0.02*0.02
endfor
;return, fit
end
